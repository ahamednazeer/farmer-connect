{% extends "base.html" %}

{% block title %}Forgot Password - Farmer Connect{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-5">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-primary text-white text-center py-4">
                        <h3 class="mb-0"><i class="fas fa-key"></i> Reset Password</h3>
                        <p class="mb-0 mt-2 opacity-75">We'll send you a reset link</p>
                    </div>
                    <div class="card-body p-5">
                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show">
                                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <div id="step1" class="step-content">
                            <p class="text-muted mb-4 text-center">
                                Enter your email address and we'll send you a link to reset your password.
                            </p>

                            <form method="POST" id="forgotPasswordForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               placeholder="Enter your registered email" required autofocus>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 mb-4">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                        <i class="fas fa-paper-plane"></i> Send Reset Link
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div id="step2" class="step-content" style="display: none;">
                            <div class="text-center">
                                <div class="mb-4">
                                    <i class="fas fa-envelope-open fa-4x text-success"></i>
                                </div>
                                <h5 class="text-success">Check Your Email!</h5>
                                <p class="text-muted">
                                    We've sent a password reset link to <strong id="sentEmail"></strong>
                                </p>
                                <p class="text-muted">
                                    The link will expire in 1 hour. If you don't see the email, check your spam folder.
                                </p>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Didn't receive the email?</strong>
                                    <button type="button" class="btn btn-link p-0" onclick="showStep1()">
                                        Try again with a different email
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="text-center my-4">
                            <hr>
                            <small class="text-muted bg-white px-3">or</small>
                        </div>

                        <!-- Back to Login -->
                        <div class="text-center">
                            <p class="text-muted mb-2">Remember your password?</p>
                            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left"></i> Back to Login
                            </a>
                        </div>

                        <!-- Help Section -->
                        <div class="mt-4 pt-4 border-top">
                            <div class="text-center">
                                <p class="text-muted mb-2">Need help?</p>
                                <div class="row">
                                    <div class="col-6">
                                        <a href="{{ url_for('contact') }}" class="btn btn-sm btn-outline-secondary w-100">
                                            <i class="fas fa-envelope"></i> Contact Support
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <a href="#" class="btn btn-sm btn-outline-secondary w-100" onclick="showFaq()">
                                            <i class="fas fa-question-circle"></i> FAQ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FAQ Modal -->
<div class="modal fade" id="faqModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-question-circle"></i> Password Reset FAQ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq1">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">
                                I'm not receiving the reset email. What should I do?
                            </button>
                        </h2>
                        <div id="collapse1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <ul>
                                    <li>Check your spam/junk folder</li>
                                    <li>Make sure you entered the correct email address</li>
                                    <li>Wait a few minutes as emails may be delayed</li>
                                    <li>Check if your email provider is blocking our emails</li>
                                    <li>Contact our support team if the problem persists</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq2">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">
                                How long is the reset link valid?
                            </button>
                        </h2>
                        <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                The password reset link is valid for 1 hour from the time it was sent. 
                                After that, you'll need to request a new reset link.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq3">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3">
                                Can I use the reset link multiple times?
                            </button>
                        </h2>
                        <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                No, each reset link can only be used once. After you successfully reset your password, 
                                the link becomes invalid. If you need to reset your password again, you'll need to request a new link.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq4">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4">
                                What if I don't remember my email address?
                            </button>
                        </h2>
                        <div id="collapse4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                If you don't remember the email address associated with your account, 
                                please contact our support team with any information you remember about your account 
                                (username, phone number, etc.) and we'll help you recover it.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('email').focus();
}

function showStep2(email) {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('sentEmail').textContent = email;
}

function showFaq() {
    const modal = new bootstrap.Modal(document.getElementById('faqModal'));
    modal.show();
}

// Form submission
document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const email = document.getElementById('email').value;
    const originalText = submitBtn.innerHTML;
    
    // Validate email
    if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    // Submit form
    fetch(`{{ url_for('auth.forgot_password') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `email=${encodeURIComponent(email)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStep2(email);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                ${data.message || 'Failed to send reset email. Please try again.'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#step1 form').insertBefore(alertDiv, document.querySelector('#step1 form').firstChild);
        }
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

// Auto-focus on email field
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('email').focus();
});

// Handle Enter key on email field
document.getElementById('email').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('forgotPasswordForm').dispatchEvent(new Event('submit'));
    }
});
</script>

<style>
.step-content {
    transition: all 0.3s ease;
}

.accordion-button:not(.collapsed) {
    background-color: var(--bs-primary);
    color: white;
}

.accordion-button:not(.collapsed)::after {
    filter: brightness(0) invert(1);
}

.btn-link {
    text-decoration: none;
}

.btn-link:hover {
    text-decoration: underline;
}

.card {
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0;
}

.input-group-text {
    background-color: #f8f9fa;
}

.alert {
    border-radius: 10px;
}
</style>
{% endblock %}