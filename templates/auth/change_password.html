{% extends "base.html" %}

{% block title %}Change Password - Farmer Connect{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0"><i class="fas fa-key"></i> Change Password</h4>
                </div>
                <div class="card-body p-4">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }}"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                    <i class="fas fa-eye" id="currentPasswordIcon"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" name="new_password" 
                                       required minlength="8" onkeyup="checkPasswordStrength()">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                    <i class="fas fa-eye" id="newPasswordIcon"></i>
                                </button>
                            </div>
                            
                            <!-- Password Strength Indicator -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="passwordStrengthBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Password strength: Weak</small>
                            </div>
                            
                            <!-- Password Requirements -->
                            <div class="mt-2">
                                <small class="text-muted">Password must contain:</small>
                                <ul class="list-unstyled small">
                                    <li id="length"><i class="fas fa-times text-danger"></i> At least 8 characters</li>
                                    <li id="lowercase"><i class="fas fa-times text-danger"></i> One lowercase letter</li>
                                    <li id="uppercase"><i class="fas fa-times text-danger"></i> One uppercase letter</li>
                                    <li id="number"><i class="fas fa-times text-danger"></i> One number</li>
                                    <li id="special"><i class="fas fa-times text-danger"></i> One special character</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" name="confirm_password" 
                                       required onkeyup="checkPasswordMatch()">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                    <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                </button>
                            </div>
                            <div id="passwordMatchMessage" class="mt-1"></div>
                        </div>

                        <!-- Security Tip -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Security Tip:</strong> Use a unique password that you haven't used elsewhere. 
                            Consider using a password manager to generate and store strong passwords.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Profile
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="fas fa-save"></i> Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + 'Icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    
    // Password requirements
    const requirements = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement indicators
    Object.keys(requirements).forEach(req => {
        const element = document.getElementById(req);
        const icon = element.querySelector('i');
        
        if (requirements[req]) {
            icon.className = 'fas fa-check text-success';
            element.classList.remove('text-muted');
            element.classList.add('text-success');
        } else {
            icon.className = 'fas fa-times text-danger';
            element.classList.remove('text-success');
            element.classList.add('text-muted');
        }
    });
    
    // Calculate strength
    const score = Object.values(requirements).filter(Boolean).length;
    let strength, color, percentage;
    
    switch(score) {
        case 0:
        case 1:
            strength = 'Very Weak';
            color = 'bg-danger';
            percentage = 20;
            break;
        case 2:
            strength = 'Weak';
            color = 'bg-warning';
            percentage = 40;
            break;
        case 3:
            strength = 'Fair';
            color = 'bg-info';
            percentage = 60;
            break;
        case 4:
            strength = 'Good';
            color = 'bg-primary';
            percentage = 80;
            break;
        case 5:
            strength = 'Strong';
            color = 'bg-success';
            percentage = 100;
            break;
    }
    
    strengthBar.className = `progress-bar ${color}`;
    strengthBar.style.width = percentage + '%';
    strengthText.textContent = `Password strength: ${strength}`;
    
    checkPasswordMatch();
    updateSubmitButton();
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('passwordMatchMessage');
    
    if (confirmPassword.length > 0) {
        if (newPassword === confirmPassword) {
            messageDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Passwords match</small>';
        } else {
            messageDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Passwords do not match</small>';
        }
    } else {
        messageDiv.innerHTML = '';
    }
    
    updateSubmitButton();
}

function updateSubmitButton() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Check all requirements
    const requirements = {
        length: newPassword.length >= 8,
        lowercase: /[a-z]/.test(newPassword),
        uppercase: /[A-Z]/.test(newPassword),
        number: /\d/.test(newPassword),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(newPassword)
    };
    
    const allRequirementsMet = Object.values(requirements).every(Boolean);
    const passwordsMatch = newPassword === confirmPassword;
    const allFieldsFilled = currentPassword && newPassword && confirmPassword;
    
    if (allFieldsFilled && allRequirementsMet && passwordsMatch) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-secondary');
        submitBtn.classList.add('btn-primary');
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-secondary');
    }
}

// Form submission
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
    
    // Re-enable button after a delay if form submission fails
    setTimeout(() => {
        if (submitBtn.disabled) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }, 5000);
});

// Add event listeners
document.getElementById('currentPassword').addEventListener('input', updateSubmitButton);
document.getElementById('newPassword').addEventListener('input', function() {
    checkPasswordStrength();
    updateSubmitButton();
});
document.getElementById('confirmPassword').addEventListener('input', function() {
    checkPasswordMatch();
    updateSubmitButton();
});

// Initial check
updateSubmitButton();
</script>
{% endblock %}