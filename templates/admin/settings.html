{% extends "base.html" %}

{% block title %}Admin Settings - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-cog"></i> Admin Settings</h4>
                </div>
                <div class="card-body">
                    <!-- Settings Navigation -->
                    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                                <i class="fas fa-cog"></i> General
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button">
                                <i class="fas fa-shield-alt"></i> Security
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button">
                                <i class="fas fa-bell"></i> Notifications
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button">
                                <i class="fas fa-database"></i> Backup
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="settingsTabContent">
                        <!-- General Settings -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <form id="generalSettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-info-circle text-primary"></i> Platform Information</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Platform Name</label>
                                            <input type="text" class="form-control" name="platform_name" value="{{ settings.platform_name or 'Farmer Connect' }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Platform Version</label>
                                            <input type="text" class="form-control" name="platform_version" value="{{ settings.platform_version or '1.0.0' }}" readonly>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Admin Email</label>
                                            <input type="email" class="form-control" name="admin_email" value="{{ settings.admin_email or session.email }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Support Email</label>
                                            <input type="email" class="form-control" name="support_email" value="{{ settings.support_email or '' }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Contact Phone</label>
                                            <input type="tel" class="form-control" name="contact_phone" value="{{ settings.contact_phone or '' }}">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-sliders-h text-primary"></i> Platform Preferences</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Default Currency</label>
                                            <select class="form-select" name="default_currency">
                                                <option value="INR" {% if settings.default_currency == 'INR' or not settings.default_currency %}selected{% endif %}>Indian Rupee (₹)</option>
                                                <option value="USD" {% if settings.default_currency == 'USD' %}selected{% endif %}>US Dollar ($)</option>
                                                <option value="EUR" {% if settings.default_currency == 'EUR' %}selected{% endif %}>Euro (€)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Date Format</label>
                                            <select class="form-select" name="date_format">
                                                <option value="dd/mm/yyyy" {% if settings.date_format == 'dd/mm/yyyy' or not settings.date_format %}selected{% endif %}>DD/MM/YYYY</option>
                                                <option value="mm/dd/yyyy" {% if settings.date_format == 'mm/dd/yyyy' %}selected{% endif %}>MM/DD/YYYY</option>
                                                <option value="yyyy-mm-dd" {% if settings.date_format == 'yyyy-mm-dd' %}selected{% endif %}>YYYY-MM-DD</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Time Zone</label>
                                            <select class="form-select" name="timezone">
                                                <option value="Asia/Kolkata" {% if settings.timezone == 'Asia/Kolkata' or not settings.timezone %}selected{% endif %}>Asia/Kolkata (IST)</option>
                                                <option value="UTC" {% if settings.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                                <option value="America/New_York" {% if settings.timezone == 'America/New_York' %}selected{% endif %}>America/New_York (EST)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="maintenance_mode" {% if settings.maintenance_mode %}checked{% endif %}>
                                            <label class="form-check-label">
                                                Enable Maintenance Mode
                                                <br><small class="text-muted">Restrict access to platform for maintenance</small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="registration_enabled" {% if settings.registration_enabled != false %}checked{% endif %}>
                                            <label class="form-check-label">
                                                Enable New User Registration
                                                <br><small class="text-muted">Allow new users to register</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save General Settings
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Security Settings -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <form id="securitySettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-lock text-warning"></i> Password Policy</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Minimum Password Length</label>
                                            <input type="number" class="form-control" name="min_password_length" min="6" max="20" value="{{ settings.min_password_length or 8 }}">
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="require_uppercase" {% if settings.require_uppercase %}checked{% endif %}>
                                            <label class="form-check-label">Require Uppercase Letters</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="require_numbers" {% if settings.require_numbers %}checked{% endif %}>
                                            <label class="form-check-label">Require Numbers</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="require_special_chars" {% if settings.require_special_chars %}checked{% endif %}>
                                            <label class="form-check-label">Require Special Characters</label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Password Expiry (days)</label>
                                            <input type="number" class="form-control" name="password_expiry_days" min="0" value="{{ settings.password_expiry_days or 0 }}">
                                            <small class="form-text text-muted">0 = never expires</small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-user-shield text-warning"></i> Account Security</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Max Login Attempts</label>
                                            <input type="number" class="form-control" name="max_login_attempts" min="3" max="10" value="{{ settings.max_login_attempts or 5 }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Account Lockout Duration (minutes)</label>
                                            <input type="number" class="form-control" name="lockout_duration" min="5" value="{{ settings.lockout_duration or 30 }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Session Timeout (minutes)</label>
                                            <input type="number" class="form-control" name="session_timeout" min="15" value="{{ settings.session_timeout or 120 }}">
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="require_email_verification" {% if settings.require_email_verification %}checked{% endif %}>
                                            <label class="form-check-label">
                                                Require Email Verification
                                                <br><small class="text-muted">New users must verify email before access</small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="enable_two_factor" {% if settings.enable_two_factor %}checked{% endif %}>
                                            <label class="form-check-label">
                                                Enable Two-Factor Authentication
                                                <br><small class="text-muted">Require 2FA for admin accounts</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save"></i> Save Security Settings
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Notification Settings -->
                        <div class="tab-pane fade" id="notifications" role="tabpanel">
                            <form id="notificationSettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-envelope text-info"></i> Email Notifications</h6>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="notify_new_orders" {% if settings.notify_new_orders != false %}checked{% endif %}>
                                            <label class="form-check-label">New Orders</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="notify_new_users" {% if settings.notify_new_users != false %}checked{% endif %}>
                                            <label class="form-check-label">New User Registrations</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="notify_payment_failures" {% if settings.notify_payment_failures != false %}checked{% endif %}>
                                            <label class="form-check-label">Payment Failures</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="notify_system_errors" {% if settings.notify_system_errors != false %}checked{% endif %}>
                                            <label class="form-check-label">System Errors</label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Daily Report Time</label>
                                            <input type="time" class="form-control" name="daily_report_time" value="{{ settings.daily_report_time or '09:00' }}">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-sms text-info"></i> SMS Notifications</h6>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="sms_enabled" {% if settings.sms_enabled %}checked{% endif %}>
                                            <label class="form-check-label">Enable SMS Notifications</label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">SMS Provider</label>
                                            <select class="form-select" name="sms_provider">
                                                <option value="twilio" {% if settings.sms_provider == 'twilio' or not settings.sms_provider %}selected{% endif %}>Twilio</option>
                                                <option value="aws" {% if settings.sms_provider == 'aws' %}selected{% endif %}>AWS SNS</option>
                                                <option value="local" {% if settings.sms_provider == 'local' %}selected{% endif %}>Local Provider</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">SMS API Key</label>
                                            <input type="password" class="form-control" name="sms_api_key" placeholder="Enter API key">
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="sms_urgent_only" {% if settings.sms_urgent_only %}checked{% endif %}>
                                            <label class="form-check-label">
                                                Urgent Notifications Only
                                                <br><small class="text-muted">Send SMS only for urgent notifications</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-info">
                                        <i class="fas fa-save"></i> Save Notification Settings
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Backup Settings -->
                        <div class="tab-pane fade" id="backup" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-database text-success"></i> Database Backup</h6>
                                    
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Automatic Backups</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableAutoBackup" {% if settings.auto_backup_enabled %}checked{% endif %}>
                                                <label class="form-check-label">Enable Automatic Backups</label>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <label class="form-label">Backup Frequency</label>
                                                <select class="form-select" name="backup_frequency">
                                                    <option value="daily" {% if settings.backup_frequency == 'daily' or not settings.backup_frequency %}selected{% endif %}>Daily</option>
                                                    <option value="weekly" {% if settings.backup_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                                                    <option value="monthly" {% if settings.backup_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <label class="form-label">Backup Time</label>
                                                <input type="time" class="form-control" name="backup_time" value="{{ settings.backup_time or '02:00' }}">
                                            </div>
                                            
                                            <div class="mt-3">
                                                <label class="form-label">Retention Period (days)</label>
                                                <input type="number" class="form-control" name="backup_retention" min="7" value="{{ settings.backup_retention or 30 }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-success" onclick="createBackup()">
                                            <i class="fas fa-download"></i> Create Backup Now
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="fas fa-history text-success"></i> Recent Backups</h6>
                                    
                                    <div class="list-group">
                                        {% for backup in recent_backups %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ backup.filename }}</h6>
                                                <small class="text-muted">{{ backup.created_at|date_format }} - {{ backup.size }}</small>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" onclick="downloadBackup('{{ backup.filename }}')">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" onclick="deleteBackup('{{ backup.filename }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-4 text-muted">
                                            <i class="fas fa-database fa-2x mb-2"></i>
                                            <p>No backups found</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="mt-3">
                                        <label class="form-label">Restore from Backup</label>
                                        <input type="file" class="form-control" id="backupFile" accept=".sql,.db">
                                        <div class="mt-2 d-grid">
                                            <button type="button" class="btn btn-warning" onclick="restoreBackup()">
                                                <i class="fas fa-upload"></i> Restore Backup
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">⚠️ This will overwrite current data!</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form submission handlers
document.getElementById('generalSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('general', e.target);
});

document.getElementById('securitySettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('security', e.target);
});

document.getElementById('notificationSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('notifications', e.target);
});

function saveSettings(type, form) {
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    fetch(`{{ url_for('admin.save_settings') }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully!');
        } else {
            alert(data.message || 'Failed to save settings');
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving settings');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function createBackup() {
    if (confirm('Create a database backup now? This may take a few minutes.')) {
        fetch(`{{ url_for('admin.create_backup') }}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Backup created successfully!');
                location.reload();
            } else {
                alert(data.message || 'Failed to create backup');
            }
        });
    }
}

function downloadBackup(filename) {
    window.location.href = `{{ url_for('admin.download_backup') }}?filename=${filename}`;
}

function deleteBackup(filename) {
    if (confirm(`Delete backup "${filename}"? This action cannot be undone.`)) {
        fetch(`{{ url_for('admin.delete_backup') }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to delete backup');
            }
        });
    }
}

function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    if (!fileInput.files[0]) {
        alert('Please select a backup file');
        return;
    }
    
    if (confirm('⚠️ WARNING: This will replace all current data with the backup. Are you sure?')) {
        const formData = new FormData();
        formData.append('backup_file', fileInput.files[0]);
        
        fetch(`{{ url_for('admin.restore_backup') }}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Backup restored successfully! Please log in again.');
                window.location.href = `{{ url_for('auth.login') }}`;
            } else {
                alert(data.message || 'Failed to restore backup');
            }
        });
    }
}
</script>
{% endblock %}