{% extends "base.html" %}

{% block title %}Consumers Management - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Consumers</h6>
                            <h3 class="mb-0">{{ stats.total_consumers }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Consumers</h6>
                            <h3 class="mb-0">{{ stats.active_consumers }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">New This Month</h6>
                            <h3 class="mb-0">{{ stats.new_this_month }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-plus fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Pending Approval</h6>
                            <h3 class="mb-0">{{ stats.pending_approval }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-users"></i> Consumers Management</h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" onclick="exportConsumers()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">All Status</option>
                                <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="rejected" {% if current_status == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search consumers..." value="{{ current_search or '' }}"
                                   onkeyup="applyFilters()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="locationFilter" onchange="applyFilters()">
                                <option value="">All Locations</option>
                                {% for location in locations %}
                                <option value="{{ location.location }}" {% if current_location == location.location %}selected{% endif %}>
                                    {{ location.location }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Consumer Details</th>
                                    <th>Contact</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Orders</th>
                                    <th>Total Spent</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consumer in consumers %}
                                <tr>
                                    <td>{{ consumer.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if consumer.profile_image %}
                                            <img src="{{ url_for('static', filename=consumer.profile_image) }}" 
                                                 class="rounded-circle me-2" width="40" height="40" alt="Profile">
                                            {% else %}
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <strong>{{ consumer.full_name }}</strong>
                                                <br><small class="text-muted">{{ consumer.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <i class="fas fa-envelope"></i> {{ consumer.email }}
                                            {% if consumer.phone %}
                                            <br><i class="fas fa-phone"></i> {{ consumer.phone }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ consumer.location or 'Not specified' }}</td>
                                    <td>
                                        {% if consumer.is_approved %}
                                        <span class="badge bg-success">Approved</span>
                                        {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ consumer.order_count or 0 }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ (consumer.total_spent or 0)|rupee }}</strong>
                                    </td>
                                    <td>{{ consumer.created_at|date_format }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="viewConsumer({{ consumer.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not consumer.is_approved %}
                                            <button type="button" class="btn btn-outline-success" 
                                                    onclick="approveConsumer({{ consumer.id }})">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="toggleConsumerStatus({{ consumer.id }}, {{ consumer.is_approved|tojson }})">
                                                {% if consumer.is_approved %}
                                                <i class="fas fa-ban"></i>
                                                {% else %}
                                                <i class="fas fa-check"></i>
                                                {% endif %}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not consumers %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No consumers found</h5>
                        <p class="text-muted">No consumers match the current filters.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consumer Details Modal -->
<div class="modal fade" id="consumerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Consumer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="consumerDetails">
                <!-- Consumer details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;
    const location = document.getElementById('locationFilter').value;
    
    const params = new URLSearchParams();
    if (status) params.set('status', status);
    if (search) params.set('search', search);
    if (location) params.set('location', location);
    
    window.location.search = params.toString();
}

function clearFilters() {
    window.location.search = '';
}

function viewConsumer(id) {
    fetch(`{{ url_for('admin.get_consumer_details') }}?id=${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const consumer = data.consumer;
                document.getElementById('consumerDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            ${consumer.profile_image ? 
                                `<img src="/static/${consumer.profile_image}" class="rounded-circle" width="120" height="120" alt="Profile">` :
                                `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                                    <i class="fas fa-user text-white fa-3x"></i>
                                </div>`
                            }
                            <h5 class="mt-3">${consumer.full_name}</h5>
                            <p class="text-muted">@${consumer.username}</p>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-borderless">
                                <tr><th>Email:</th><td>${consumer.email}</td></tr>
                                <tr><th>Phone:</th><td>${consumer.phone || 'Not provided'}</td></tr>
                                <tr><th>Location:</th><td>${consumer.location || 'Not specified'}</td></tr>
                                <tr><th>Status:</th><td>
                                    ${consumer.is_approved ? 
                                        '<span class="badge bg-success">Approved</span>' : 
                                        '<span class="badge bg-warning">Pending</span>'
                                    }
                                </td></tr>
                                <tr><th>Total Orders:</th><td>${consumer.order_count || 0}</td></tr>
                                <tr><th>Total Spent:</th><td>${consumer.total_spent || 0}</td></tr>
                                <tr><th>Joined:</th><td>${new Date(consumer.created_at).toLocaleDateString()}</td></tr>
                                <tr><th>Last Active:</th><td>${consumer.last_active ? new Date(consumer.last_active).toLocaleDateString() : 'Never'}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('consumerModal'));
                modal.show();
            } else {
                alert('Failed to load consumer details');
            }
        });
}

function approveConsumer(id) {
    if (confirm('Are you sure you want to approve this consumer?')) {
        fetch(`{{ url_for('admin.approve_consumer') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to approve consumer');
            }
        });
    }
}

function toggleConsumerStatus(id, currentStatus) {
    const action = currentStatus ? 'suspend' : 'activate';
    if (confirm(`Are you sure you want to ${action} this consumer?`)) {
        fetch(`{{ url_for('admin.toggle_consumer_status') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: id, is_approved: !currentStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to update consumer status');
            }
        });
    }
}

function exportConsumers() {
    window.location.href = `{{ url_for('admin.export_consumers') }}`;
}

// Auto search after typing
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        applyFilters();
    }, 500);
});
</script>
{% endblock %}